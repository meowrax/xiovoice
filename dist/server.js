const _0x1abec0=_0x49d4;(function(_0xcce8b6,_0x567754){const _0x231d5f=_0x49d4,_0x245b1d=_0xcce8b6();while(!![]){try{const _0x2fdf87=parseInt(_0x231d5f(0x18d))/0x1*(parseInt(_0x231d5f(0x196))/0x2)+-parseInt(_0x231d5f(0x152))/0x3+-parseInt(_0x231d5f(0x165))/0x4+-parseInt(_0x231d5f(0x160))/0x5+-parseInt(_0x231d5f(0x15a))/0x6*(-parseInt(_0x231d5f(0x1b2))/0x7)+-parseInt(_0x231d5f(0x16f))/0x8+parseInt(_0x231d5f(0x1a9))/0x9;if(_0x2fdf87===_0x567754)break;else _0x245b1d['push'](_0x245b1d['shift']());}catch(_0x527b0e){_0x245b1d['push'](_0x245b1d['shift']());}}}(_0x5575,0x7501b));const express=require(_0x1abec0(0x166)),http=require('http'),WebSocket=require('ws'),{v4:uuidv4}=require(_0x1abec0(0x188)),path=require('path'),app=express(),server=http[_0x1abec0(0x15d)](app),wss=new WebSocket[(_0x1abec0(0x17c))]({'server':server}),rooms=new Map(),clients=new Map(),rateLimit=new Map(),RATE_LIMIT_WINDOW=0xea60,RATE_LIMIT_MAX_REQUESTS=0x3,MAX_ROOMS=0x5,EMPTY_ROOM_TIMEOUT=0x927c0,csrfTokens=new Map(),CSRF_TOKEN_LIFETIME=0x493e0,suspiciousIPs=new Set(),ERR={'E001':_0x1abec0(0x15c),'E002':'a3f8b2c1-7e4d-4a9f-8c6b-2d1e5f3a7b9c','E003':_0x1abec0(0x186),'E004':_0x1abec0(0x164),'E005':_0x1abec0(0x180),'E006':_0x1abec0(0x154)};function getClientIP(_0xc67a6b){const _0x16992b=_0x1abec0;return _0xc67a6b[_0x16992b(0x149)][_0x16992b(0x16e)]||_0xc67a6b[_0x16992b(0x149)][_0x16992b(0x176)]?.[_0x16992b(0x185)](',')[0x0]||_0xc67a6b['headers']['x-real-ip']||_0xc67a6b[_0x16992b(0x15e)]['remoteAddress']||_0xc67a6b[_0x16992b(0x1a7)][_0x16992b(0x172)]||_0x16992b(0x198);}function checkRateLimit(_0x21cfc5){const _0x5d0e7f=_0x1abec0;if(suspiciousIPs[_0x5d0e7f(0x19e)](_0x21cfc5))return!0x1;const _0x330884=Date[_0x5d0e7f(0x19b)](),_0x487716=rateLimit[_0x5d0e7f(0x19c)](_0x21cfc5);return _0x487716?_0x330884>_0x487716[_0x5d0e7f(0x179)]?(rateLimit[_0x5d0e7f(0x16a)](_0x21cfc5,{'count':0x1,'resetTime':_0x330884+0xea60}),!0x0):_0x487716[_0x5d0e7f(0x17d)]>=0x3?(suspiciousIPs[_0x5d0e7f(0x14b)](_0x21cfc5),setTimeout(()=>suspiciousIPs[_0x5d0e7f(0x1a5)](_0x21cfc5),0x36ee80),!0x1):(_0x487716['count']++,!0x0):(rateLimit[_0x5d0e7f(0x16a)](_0x21cfc5,{'count':0x1,'resetTime':_0x330884+0xea60}),!0x0);}function isValidRequest(_0x4f1b16){const _0x10c116=_0x1abec0,_0x538ea9=_0x4f1b16['headers'][_0x10c116(0x170)]||'',_0x65f052=_0x4f1b16[_0x10c116(0x149)][_0x10c116(0x158)]||'',_0x40b549=_0x4f1b16['headers'][_0x10c116(0x171)]||'',_0x14de8b=_0x4f1b16['headers'][_0x10c116(0x146)]||'',_0x3916ca=[_0x10c116(0x17e),_0x10c116(0x187),_0x10c116(0x1b1),_0x10c116(0x143),_0x10c116(0x1a4),_0x10c116(0x17a)][_0x10c116(0x18f)](_0x1663be=>_0x538ea9[_0x10c116(0x1a8)](_0x1663be)),_0x39a2af=_0x65f052[_0x10c116(0x1a8)]('xiovoice.onrender.com')||_0x65f052[_0x10c116(0x1a8)](_0x10c116(0x177));return _0x3916ca&&_0x39a2af&&(_0x10c116(0x161)===_0x40b549&&_0x10c116(0x1a3)===_0x14de8b);}function broadcast(_0x9c123d,_0x567312,_0x20654e=null){const _0x2155c7=_0x1abec0,_0x270a74=rooms[_0x2155c7(0x19c)](_0x9c123d);_0x270a74&&_0x270a74[_0x2155c7(0x148)][_0x2155c7(0x141)]((_0x380503,_0x4dd165)=>{const _0x2d9fb3=_0x2155c7;if(_0x20654e&&_0x4dd165===_0x20654e)return;const _0x55904a=clients[_0x2d9fb3(0x19c)](_0x4dd165);_0x55904a&&_0x55904a['ws']['readyState']===WebSocket[_0x2d9fb3(0x17b)]&&_0x55904a['ws'][_0x2d9fb3(0x1a1)](JSON['stringify'](_0x567312));});}function sendToClient(_0x1ce123,_0x1bf36c){const _0x19f533=_0x1abec0,_0x3fcd28=clients[_0x19f533(0x19c)](_0x1ce123);_0x3fcd28&&_0x3fcd28['ws'][_0x19f533(0x1ac)]===WebSocket[_0x19f533(0x17b)]&&_0x3fcd28['ws'][_0x19f533(0x1a1)](JSON[_0x19f533(0x18a)](_0x1bf36c));}function handleMessage(_0x386f4d,_0x22cd47){const _0x444404=_0x1abec0,_0x10f1c8=clients['get'](_0x386f4d);if(_0x10f1c8)switch(_0x22cd47['type']){case _0x444404(0x15f):{const {roomId:_0x31e528,nickname:_0x2687ed}=_0x22cd47,_0x23bed4=rooms[_0x444404(0x19c)](_0x31e528);if(!_0x23bed4)return void sendToClient(_0x386f4d,{'type':'error','message':'Комната\x20не\x20найдена'});const _0x18422f=uuidv4()[_0x444404(0x184)](0x0,0x8);_0x10f1c8[_0x444404(0x194)]=_0x31e528,_0x10f1c8[_0x444404(0x16b)]=_0x2687ed,_0x10f1c8[_0x444404(0x150)]=_0x18422f,_0x23bed4[_0x444404(0x148)]['set'](_0x386f4d,{'id':_0x386f4d,'nickname':_0x2687ed,'userKey':_0x18422f,'joinedAt':Date[_0x444404(0x19b)](),'isMuted':!0x1,'isDeafened':!0x1,'isScreenSharing':!0x1,'avatar':null}),_0x23bed4[_0x444404(0x1ad)]=null,sendToClient(_0x386f4d,{'type':_0x444404(0x18e),'roomId':_0x31e528,'userKey':_0x18422f,'participants':Array[_0x444404(0x175)](_0x23bed4[_0x444404(0x148)][_0x444404(0x159)]()),'messages':_0x23bed4[_0x444404(0x189)]['slice'](-0x32)}),broadcast(_0x31e528,{'type':_0x444404(0x18b),'user':{'id':_0x386f4d,'nickname':_0x2687ed,'userKey':_0x18422f}},_0x386f4d),broadcast(_0x31e528,{'type':_0x444404(0x144),'participants':Array[_0x444404(0x175)](_0x23bed4[_0x444404(0x148)][_0x444404(0x159)]())});break;}case _0x444404(0x182):{const {roomId:_0x58aeb9,content:_0x1b5965,image:_0x2c3970}=_0x22cd47,_0x142243=rooms[_0x444404(0x19c)](_0x58aeb9);if(!_0x142243)return;const _0x8da8ed={'id':uuidv4(),'senderId':_0x386f4d,'senderName':_0x10f1c8[_0x444404(0x16b)],'content':_0x1b5965,'image':_0x2c3970,'timestamp':Date[_0x444404(0x19b)]()};_0x142243[_0x444404(0x189)]['push'](_0x8da8ed),_0x142243[_0x444404(0x189)][_0x444404(0x1af)]>0xc8&&(_0x142243['messages']=_0x142243[_0x444404(0x189)]['slice'](-0x64)),broadcast(_0x58aeb9,{'type':'chat-message','message':_0x8da8ed});break;}case'webrtc-offer':{const {targetId:_0xdce8ef,offer:_0x2f5a0e}=_0x22cd47;sendToClient(_0xdce8ef,{'type':_0x444404(0x16d),'senderId':_0x386f4d,'senderName':_0x10f1c8[_0x444404(0x16b)],'offer':_0x2f5a0e});break;}case _0x444404(0x17f):{const {targetId:_0x5099da,answer:_0x399fda}=_0x22cd47;sendToClient(_0x5099da,{'type':_0x444404(0x17f),'senderId':_0x386f4d,'answer':_0x399fda});break;}case'webrtc-ice-candidate':{const {targetId:_0x1112cc,candidate:_0x9e59a0}=_0x22cd47;sendToClient(_0x1112cc,{'type':_0x444404(0x155),'senderId':_0x386f4d,'candidate':_0x9e59a0});break;}case _0x444404(0x195):{const _0x6fa839=rooms[_0x444404(0x19c)](_0x10f1c8[_0x444404(0x194)]);if(!_0x6fa839)return;const _0x14fabd=_0x6fa839[_0x444404(0x148)][_0x444404(0x19c)](_0x386f4d);_0x14fabd&&(_0x14fabd[_0x444404(0x15b)]=_0x22cd47[_0x444404(0x15b)],broadcast(_0x10f1c8['roomId'],{'type':_0x444404(0x19f),'clientId':_0x386f4d,'isMuted':_0x22cd47[_0x444404(0x15b)]}));break;}case _0x444404(0x1b4):{const _0x1867fa=rooms['get'](_0x10f1c8[_0x444404(0x194)]);if(!_0x1867fa)return;const _0x2c1b8c=_0x1867fa['participants'][_0x444404(0x19c)](_0x386f4d);_0x2c1b8c&&(_0x2c1b8c['avatar']=_0x22cd47[_0x444404(0x142)],broadcast(_0x10f1c8[_0x444404(0x194)],{'type':_0x444404(0x1b3),'clientId':_0x386f4d,'avatar':_0x22cd47[_0x444404(0x142)]}));break;}case _0x444404(0x19d):{const _0x165507=rooms[_0x444404(0x19c)](_0x10f1c8[_0x444404(0x194)]);if(!_0x165507)return;const _0x30db9c=_0x165507[_0x444404(0x148)]['get'](_0x386f4d);_0x30db9c&&(_0x30db9c[_0x444404(0x157)]=_0x22cd47[_0x444404(0x157)],broadcast(_0x10f1c8['roomId'],{'type':_0x444404(0x151),'clientId':_0x386f4d,'isDeafened':_0x22cd47['isDeafened']}));break;}case _0x444404(0x178):{const _0xec550a=rooms['get'](_0x10f1c8[_0x444404(0x194)]);if(!_0xec550a)return;const _0x36b5fa=_0xec550a['participants'][_0x444404(0x19c)](_0x386f4d);_0x36b5fa&&(_0x36b5fa[_0x444404(0x167)]=!0x0,broadcast(_0x10f1c8[_0x444404(0x194)],{'type':_0x444404(0x178),'clientId':_0x386f4d,'nickname':_0x10f1c8['nickname']}));break;}case'screen-share-stopped':{const _0x3f722d=rooms[_0x444404(0x19c)](_0x10f1c8[_0x444404(0x194)]);if(!_0x3f722d)return;const _0x205ce2=_0x3f722d[_0x444404(0x148)]['get'](_0x386f4d);_0x205ce2&&(_0x205ce2['isScreenSharing']=!0x1,broadcast(_0x10f1c8['roomId'],{'type':_0x444404(0x14f),'clientId':_0x386f4d}));break;}case _0x444404(0x19a):{const {targetId:_0x33d396}=_0x22cd47;sendToClient(_0x33d396,{'type':'screen-requested','requesterId':_0x386f4d});break;}}}function _0x49d4(_0xa4c452,_0x3d7027){const _0x5575b8=_0x5575();return _0x49d4=function(_0x49d43f,_0x42500e){_0x49d43f=_0x49d43f-0x141;let _0x2f6beb=_0x5575b8[_0x49d43f];return _0x2f6beb;},_0x49d4(_0xa4c452,_0x3d7027);}setInterval(()=>{const _0x3e1e4c=_0x1abec0,_0x212309=Date[_0x3e1e4c(0x19b)]();for(const [_0x5399cc,_0x42526b]of rateLimit[_0x3e1e4c(0x1b0)]())_0x212309>_0x42526b[_0x3e1e4c(0x179)]&&rateLimit['delete'](_0x5399cc);},0xea60),app[_0x1abec0(0x16a)]('trust\x20proxy',!0x0),app[_0x1abec0(0x1ab)](express['static'](path[_0x1abec0(0x1a6)](__dirname,'public'))),app[_0x1abec0(0x1ab)](express['json']({'limit':'50mb'})),app[_0x1abec0(0x19c)]('/',(_0x466871,_0x485e87)=>{const _0x341bdb=_0x1abec0;_0x485e87[_0x341bdb(0x163)](path[_0x341bdb(0x1a6)](__dirname,'public',_0x341bdb(0x199)));}),app['get'](_0x1abec0(0x197),(_0x4070d3,_0x3b23ba)=>{const _0x13675e=_0x1abec0;_0x3b23ba[_0x13675e(0x163)](path[_0x13675e(0x1a6)](__dirname,_0x13675e(0x183),_0x13675e(0x199)));}),app[_0x1abec0(0x19c)](_0x1abec0(0x18c),(_0x3ecc65,_0x21184a)=>{const _0xa53ce1=_0x1abec0,_0x2f4c5f=uuidv4(),_0x6567d4=getClientIP(_0x3ecc65);csrfTokens[_0xa53ce1(0x16a)](_0x2f4c5f,{'ip':_0x6567d4,'createdAt':Date[_0xa53ce1(0x19b)]()}),setTimeout(()=>csrfTokens[_0xa53ce1(0x1a5)](_0x2f4c5f),0x493e0),_0x21184a[_0xa53ce1(0x153)]({'d':_0x2f4c5f});}),app['post']('/x/c',(_0x2f0f40,_0x219736)=>{const _0xd80c03=_0x1abec0,_0x2737cf=getClientIP(_0x2f0f40),_0x4747b5=_0x2f0f40[_0xd80c03(0x149)]['x-t'];if(!_0x4747b5||!csrfTokens[_0xd80c03(0x19e)](_0x4747b5))return _0x219736[_0xd80c03(0x1ae)](0x193)[_0xd80c03(0x153)]({'c':ERR[_0xd80c03(0x1a2)]});const _0x37f37a=csrfTokens[_0xd80c03(0x19c)](_0x4747b5);csrfTokens[_0xd80c03(0x1a5)](_0x4747b5);const _0x1113e6=Date[_0xd80c03(0x19b)]()-_0x37f37a[_0xd80c03(0x191)];if(_0x1113e6>0x493e0)return _0x219736[_0xd80c03(0x1ae)](0x193)[_0xd80c03(0x153)]({'c':ERR[_0xd80c03(0x192)]});if(_0x1113e6<0x3e8)return suspiciousIPs[_0xd80c03(0x14b)](_0x2737cf),_0x219736[_0xd80c03(0x1ae)](0x193)[_0xd80c03(0x153)]({'c':ERR['E003']});if(!isValidRequest(_0x2f0f40))return suspiciousIPs[_0xd80c03(0x14b)](_0x2737cf),_0x219736[_0xd80c03(0x1ae)](0x193)[_0xd80c03(0x153)]({'c':ERR[_0xd80c03(0x14e)]});if(!checkRateLimit(_0x2737cf))return _0x219736[_0xd80c03(0x1ae)](0x1ad)[_0xd80c03(0x153)]({'c':ERR[_0xd80c03(0x147)]});if(rooms[_0xd80c03(0x16c)]>=0x5)return _0x219736[_0xd80c03(0x1ae)](0x1f7)['json']({'c':ERR[_0xd80c03(0x173)],'limit':!0x0});const _0x3fe208=uuidv4()[_0xd80c03(0x184)](0x0,0x8),_0x43374=uuidv4()[_0xd80c03(0x184)](0x0,0xc);rooms['set'](_0x3fe208,{'id':_0x3fe208,'adminKey':_0x43374,'createdAt':Date['now'](),'lastEmptyTime':Date[_0xd80c03(0x19b)](),'participants':new Map(),'messages':[]}),_0x219736['json']({'r':_0x3fe208,'k':_0x43374,'l':_0xd80c03(0x145)+_0x3fe208});}),app[_0x1abec0(0x19c)](_0x1abec0(0x168),(_0xc954bb,_0x459d09)=>{const _0x5554df=_0x1abec0,_0xf7872a=rooms[_0x5554df(0x19c)](_0xc954bb[_0x5554df(0x169)][_0x5554df(0x194)]);if(!_0xf7872a)return _0x459d09[_0x5554df(0x1ae)](0x194)['json']({'c':0x0});_0x459d09[_0x5554df(0x153)]({'e':0x1,'p':_0xf7872a[_0x5554df(0x148)]['size']});}),wss['on'](_0x1abec0(0x15e),_0x4f09d7=>{const _0x37a224=_0x1abec0,_0x461781=uuidv4();clients[_0x37a224(0x16a)](_0x461781,{'ws':_0x4f09d7,'roomId':null,'nickname':null,'odId':null}),_0x4f09d7[_0x37a224(0x1a1)](JSON[_0x37a224(0x18a)]({'type':_0x37a224(0x1aa),'clientId':_0x461781})),_0x4f09d7['on'](_0x37a224(0x193),_0x533e67=>{const _0x2ccb30=_0x37a224;try{const _0x2bef91=JSON['parse'](_0x533e67);handleMessage(_0x461781,_0x2bef91);}catch(_0x4ac786){console[_0x2ccb30(0x14a)](_0x2ccb30(0x190),_0x4ac786);}}),_0x4f09d7['on'](_0x37a224(0x14c),()=>{const _0x35fe63=_0x37a224,_0x4d19e3=clients[_0x35fe63(0x19c)](_0x461781);if(_0x4d19e3&&_0x4d19e3[_0x35fe63(0x194)]){const _0x1d164f=rooms[_0x35fe63(0x19c)](_0x4d19e3[_0x35fe63(0x194)]);_0x1d164f&&(_0x1d164f['participants'][_0x35fe63(0x1a5)](_0x461781),0x0===_0x1d164f[_0x35fe63(0x148)][_0x35fe63(0x16c)]&&(_0x1d164f['lastEmptyTime']=Date[_0x35fe63(0x19b)]()),broadcast(_0x4d19e3[_0x35fe63(0x194)],{'type':_0x35fe63(0x181),'clientId':_0x461781,'nickname':_0x4d19e3[_0x35fe63(0x16b)]}),broadcast(_0x4d19e3[_0x35fe63(0x194)],{'type':_0x35fe63(0x144),'participants':Array['from'](_0x1d164f[_0x35fe63(0x148)][_0x35fe63(0x159)]())}));}clients['delete'](_0x461781);});}),setInterval(()=>{const _0xf4cca5=_0x1abec0,_0x5b8337=Date[_0xf4cca5(0x19b)]();rooms['forEach']((_0xd68ef5,_0xf1a7ff)=>{const _0x43f74b=_0xf4cca5;0x0===_0xd68ef5[_0x43f74b(0x148)][_0x43f74b(0x16c)]&&_0xd68ef5[_0x43f74b(0x1ad)]&&_0x5b8337-_0xd68ef5['lastEmptyTime']>0x927c0&&(rooms[_0x43f74b(0x1a5)](_0xf1a7ff),console[_0x43f74b(0x1a0)](_0x43f74b(0x14d)+_0xf1a7ff+_0x43f74b(0x174)));});},0xea60);const PORT=process[_0x1abec0(0x162)][_0x1abec0(0x156)]||0xbb8;server['listen'](PORT,()=>{const _0x331873=_0x1abec0;console[_0x331873(0x1a0)]('Server\x20running\x20on\x20http://localhost:'+PORT);});function _0x5575(){const _0xe69a36=['d107fc57-3a5d-49c6-95e4-b5648000dc17','createServer','connection','join-room','4075380EJgFBC','same-origin','env','sendFile','f4e3d2c1-b0a9-8f7e-6d5c-4b3a2f1e0d9c','3611440LTgBvG','express','isScreenSharing','/x/r/:roomId','params','set','nickname','size','webrtc-offer','cf-connecting-ip','2364112VLlYDA','user-agent','sec-fetch-site','remoteAddress','E006','\x20deleted\x20(empty\x20for\x2010\x20minutes)','from','x-forwarded-for','localhost','screen-share-started','resetTime','Opera','OPEN','Server','count','Mozilla','webrtc-answer','7b6a5f4e-3d2c-1b0a-9f8e-7d6c5b4a3f2e','user-left','chat-message','public','slice','split','9c8b7a6f-5e4d-3c2b-1a0f-e9d8c7b6a5f4','Chrome','uuid','messages','stringify','user-joined','/x/t','605RPXzud','joined','some','Failed\x20to\x20parse\x20message:','createdAt','E002','message','roomId','toggle-mute','2352eWbbbC','/room/:roomId','unknown','index.html','request-screen','now','get','toggle-deafen','has','user-mute-changed','log','send','E001','cors','Edge','delete','join','socket','includes','14168997aeSpxS','connected','use','readyState','lastEmptyTime','status','length','entries','Safari','1090061YUebqp','user-avatar-changed','update-avatar','forEach','avatar','Firefox','participants-update','/room/','sec-fetch-mode','E005','participants','headers','error','add','close','Room\x20','E004','screen-share-stopped','userKey','user-deafen-changed','313650HwWTzk','json','2e1d0c9b-8a7f-6e5d-4c3b-2a1f0e9d8c7b','webrtc-ice-candidate','PORT','isDeafened','origin','values','12zrJFRd','isMuted'];_0x5575=function(){return _0xe69a36;};return _0x5575();}