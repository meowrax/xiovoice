const _0x3365ab=_0x458b;(function(_0x468026,_0x553b5a){const _0x436092=_0x458b,_0x448d13=_0x468026();while(!![]){try{const _0x243d6f=-parseInt(_0x436092(0xfb))/0x1+-parseInt(_0x436092(0xe1))/0x2+parseInt(_0x436092(0x13a))/0x3*(parseInt(_0x436092(0x11d))/0x4)+parseInt(_0x436092(0x137))/0x5+-parseInt(_0x436092(0x13b))/0x6+-parseInt(_0x436092(0x125))/0x7*(parseInt(_0x436092(0x136))/0x8)+-parseInt(_0x436092(0x124))/0x9*(parseInt(_0x436092(0x139))/0xa);if(_0x243d6f===_0x553b5a)break;else _0x448d13['push'](_0x448d13['shift']());}catch(_0x2086ff){_0x448d13['push'](_0x448d13['shift']());}}}(_0x2f25,0x6a87e));const express=require('express'),http=require(_0x3365ab(0x10f)),WebSocket=require('ws'),{v4:uuidv4}=require('uuid'),path=require(_0x3365ab(0x11f)),app=express(),server=http[_0x3365ab(0xed)](app),wss=new WebSocket[(_0x3365ab(0x113))]({'server':server}),rooms=new Map(),clients=new Map(),rateLimit=new Map(),RATE_LIMIT_WINDOW=0xea60,RATE_LIMIT_MAX_REQUESTS=0x3,MAX_ROOMS=0x5,EMPTY_ROOM_TIMEOUT=0x927c0,csrfTokens=new Map(),CSRF_TOKEN_LIFETIME=0x493e0,suspiciousIPs=new Set(),ERR={'E001':_0x3365ab(0x100),'E002':_0x3365ab(0x13d),'E003':_0x3365ab(0x132),'E004':'f4e3d2c1-b0a9-8f7e-6d5c-4b3a2f1e0d9c','E005':'7b6a5f4e-3d2c-1b0a-9f8e-7d6c5b4a3f2e','E006':'2e1d0c9b-8a7f-6e5d-4c3b-2a1f0e9d8c7b'};function getClientIP(_0x5a0124){const _0x5e22f3=_0x3365ab;return _0x5a0124[_0x5e22f3(0x112)][_0x5e22f3(0x141)]||_0x5a0124[_0x5e22f3(0x112)]['x-forwarded-for']?.[_0x5e22f3(0xe8)](',')[0x0]||_0x5a0124[_0x5e22f3(0x112)][_0x5e22f3(0x10e)]||_0x5a0124[_0x5e22f3(0x13e)][_0x5e22f3(0x10b)]||_0x5a0124[_0x5e22f3(0x130)][_0x5e22f3(0x10b)]||_0x5e22f3(0x117);}function checkRateLimit(_0x5c838d){const _0x43d505=_0x3365ab;if(suspiciousIPs[_0x43d505(0xdb)](_0x5c838d))return!0x1;const _0xd7f45b=Date[_0x43d505(0xdc)](),_0x1b4414=rateLimit[_0x43d505(0x11a)](_0x5c838d);return _0x1b4414?_0xd7f45b>_0x1b4414[_0x43d505(0xe0)]?(rateLimit['set'](_0x5c838d,{'count':0x1,'resetTime':_0xd7f45b+0xea60}),!0x0):_0x1b4414['count']>=0x3?(suspiciousIPs[_0x43d505(0x12a)](_0x5c838d),setTimeout(()=>suspiciousIPs[_0x43d505(0x12c)](_0x5c838d),0x36ee80),!0x1):(_0x1b4414[_0x43d505(0x122)]++,!0x0):(rateLimit[_0x43d505(0x103)](_0x5c838d,{'count':0x1,'resetTime':_0xd7f45b+0xea60}),!0x0);}function _0x2f25(){const _0x445587=['messages','send','cors','createServer','push','forEach','type','connected','OPEN','webrtc-answer','request-screen','post','status','params','avatar','sendFile','log','488310nSZvjn','use','/room/','parse','E006','d107fc57-3a5d-49c6-95e4-b5648000dc17','close','userKey','set','length','join-room','values','Комната\x20не\x20найдена','user-deafen-changed','stringify','nickname','remoteAddress','screen-share-stopped','roomId','x-real-ip','http','lastEmptyTime','user-agent','headers','Server','screen-requested','webrtc-ice-candidate','chat-message','unknown','createdAt','message','get','isScreenSharing','listen','2706604isQiFB','participants','path','static','Mozilla','count','/x/t','147717TZtbnE','7qrAqsu','sec-fetch-mode','Firefox','trust\x20proxy','slice','add','webrtc-offer','delete','isMuted','x-t','readyState','socket','user-joined','9c8b7a6f-5e4d-3c2b-1a0f-e9d8c7b6a5f4','Opera','size','isDeafened','141216UBftXh','4338540zeHMQK','public','10GjzDVg','3NQrqOG','2566884HTmfHA','index.html','a3f8b2c1-7e4d-4a9f-8c6b-2d1e5f3a7b9c','connection','\x20deleted\x20(empty\x20for\x2010\x20minutes)','json','cf-connecting-ip','same-origin','E004','from','screen-share-started','join','has','now','toggle-mute','50mb','participants-update','resetTime','315640LQpqdr','error','env','Chrome','Failed\x20to\x20parse\x20message:','Edge','includes','split','joined'];_0x2f25=function(){return _0x445587;};return _0x2f25();}function isValidRequest(_0x5e8aeb){const _0x17a2ae=_0x3365ab,_0x4dd01d=_0x5e8aeb['headers'][_0x17a2ae(0x111)]||'',_0x19e54f=_0x5e8aeb['headers']['origin']||'',_0x1ced0=_0x5e8aeb[_0x17a2ae(0x112)]['sec-fetch-site']||'',_0x4c659c=_0x5e8aeb[_0x17a2ae(0x112)][_0x17a2ae(0x126)]||'',_0x98fb81=[_0x17a2ae(0x121),_0x17a2ae(0xe4),'Safari',_0x17a2ae(0x127),_0x17a2ae(0xe6),_0x17a2ae(0x133)]['some'](_0x36eaba=>_0x4dd01d[_0x17a2ae(0xe7)](_0x36eaba)),_0x44f11f=_0x19e54f[_0x17a2ae(0xe7)]('xiovoice.onrender.com')||_0x19e54f[_0x17a2ae(0xe7)]('localhost');return _0x98fb81&&_0x44f11f&&(_0x17a2ae(0x142)===_0x1ced0&&_0x17a2ae(0xec)===_0x4c659c);}function broadcast(_0x65e225,_0x8b3014,_0x97556c=null){const _0x5a2591=_0x3365ab,_0x271ca9=rooms['get'](_0x65e225);_0x271ca9&&_0x271ca9[_0x5a2591(0x11e)][_0x5a2591(0xef)]((_0x4a7a5a,_0x4e3968)=>{const _0x17c84b=_0x5a2591;if(_0x97556c&&_0x4e3968===_0x97556c)return;const _0x49e7d5=clients[_0x17c84b(0x11a)](_0x4e3968);_0x49e7d5&&_0x49e7d5['ws'][_0x17c84b(0x12f)]===WebSocket[_0x17c84b(0xf2)]&&_0x49e7d5['ws']['send'](JSON[_0x17c84b(0x109)](_0x8b3014));});}function sendToClient(_0x498829,_0x4ec0d7){const _0x170d15=_0x3365ab,_0x50c8b9=clients[_0x170d15(0x11a)](_0x498829);_0x50c8b9&&_0x50c8b9['ws'][_0x170d15(0x12f)]===WebSocket[_0x170d15(0xf2)]&&_0x50c8b9['ws'][_0x170d15(0xeb)](JSON['stringify'](_0x4ec0d7));}function handleMessage(_0x2ba435,_0x644a1e){const _0x23c3fe=_0x3365ab,_0x54acc5=clients[_0x23c3fe(0x11a)](_0x2ba435);if(_0x54acc5)switch(_0x644a1e[_0x23c3fe(0xf0)]){case _0x23c3fe(0x105):{const {roomId:_0x269089,nickname:_0x3bac89}=_0x644a1e,_0x207724=rooms[_0x23c3fe(0x11a)](_0x269089);if(!_0x207724)return void sendToClient(_0x2ba435,{'type':_0x23c3fe(0xe2),'message':_0x23c3fe(0x107)});const _0x5830dd=uuidv4()['slice'](0x0,0x8);_0x54acc5[_0x23c3fe(0x10d)]=_0x269089,_0x54acc5['nickname']=_0x3bac89,_0x54acc5[_0x23c3fe(0x102)]=_0x5830dd,_0x207724[_0x23c3fe(0x11e)][_0x23c3fe(0x103)](_0x2ba435,{'id':_0x2ba435,'nickname':_0x3bac89,'userKey':_0x5830dd,'joinedAt':Date[_0x23c3fe(0xdc)](),'isMuted':!0x1,'isDeafened':!0x1,'isScreenSharing':!0x1,'avatar':null}),_0x207724[_0x23c3fe(0x110)]=null,sendToClient(_0x2ba435,{'type':_0x23c3fe(0xe9),'roomId':_0x269089,'userKey':_0x5830dd,'participants':Array[_0x23c3fe(0xd8)](_0x207724['participants'][_0x23c3fe(0x106)]()),'messages':_0x207724['messages']['slice'](-0x32)}),broadcast(_0x269089,{'type':_0x23c3fe(0x131),'user':{'id':_0x2ba435,'nickname':_0x3bac89,'userKey':_0x5830dd}},_0x2ba435),broadcast(_0x269089,{'type':_0x23c3fe(0xdf),'participants':Array[_0x23c3fe(0xd8)](_0x207724[_0x23c3fe(0x11e)][_0x23c3fe(0x106)]())});break;}case'chat-message':{const {roomId:_0x54b10c,content:_0x455d49,image:_0x5f3a27}=_0x644a1e,_0x10bed6=rooms[_0x23c3fe(0x11a)](_0x54b10c);if(!_0x10bed6)return;const _0x28a79c={'id':uuidv4(),'senderId':_0x2ba435,'senderName':_0x54acc5['nickname'],'content':_0x455d49,'image':_0x5f3a27,'timestamp':Date[_0x23c3fe(0xdc)]()};_0x10bed6[_0x23c3fe(0xea)][_0x23c3fe(0xee)](_0x28a79c),_0x10bed6[_0x23c3fe(0xea)][_0x23c3fe(0x104)]>0xc8&&(_0x10bed6[_0x23c3fe(0xea)]=_0x10bed6['messages'][_0x23c3fe(0x129)](-0x64)),broadcast(_0x54b10c,{'type':_0x23c3fe(0x116),'message':_0x28a79c});break;}case _0x23c3fe(0x12b):{const {targetId:_0x2bfda4,offer:_0x502031}=_0x644a1e;sendToClient(_0x2bfda4,{'type':_0x23c3fe(0x12b),'senderId':_0x2ba435,'senderName':_0x54acc5[_0x23c3fe(0x10a)],'offer':_0x502031});break;}case _0x23c3fe(0xf3):{const {targetId:_0x4878d0,answer:_0x5002a6}=_0x644a1e;sendToClient(_0x4878d0,{'type':'webrtc-answer','senderId':_0x2ba435,'answer':_0x5002a6});break;}case _0x23c3fe(0x115):{const {targetId:_0x546672,candidate:_0x2f4a5f}=_0x644a1e;sendToClient(_0x546672,{'type':_0x23c3fe(0x115),'senderId':_0x2ba435,'candidate':_0x2f4a5f});break;}case _0x23c3fe(0xdd):{const _0x3b908c=rooms[_0x23c3fe(0x11a)](_0x54acc5['roomId']);if(!_0x3b908c)return;const _0x13ebff=_0x3b908c[_0x23c3fe(0x11e)][_0x23c3fe(0x11a)](_0x2ba435);_0x13ebff&&(_0x13ebff[_0x23c3fe(0x12d)]=_0x644a1e[_0x23c3fe(0x12d)],broadcast(_0x54acc5['roomId'],{'type':'user-mute-changed','clientId':_0x2ba435,'isMuted':_0x644a1e[_0x23c3fe(0x12d)]}));break;}case'update-avatar':{const _0x1bbf6e=rooms[_0x23c3fe(0x11a)](_0x54acc5[_0x23c3fe(0x10d)]);if(!_0x1bbf6e)return;const _0x52d3e9=_0x1bbf6e[_0x23c3fe(0x11e)][_0x23c3fe(0x11a)](_0x2ba435);_0x52d3e9&&(_0x52d3e9['avatar']=_0x644a1e['avatar'],broadcast(_0x54acc5['roomId'],{'type':'user-avatar-changed','clientId':_0x2ba435,'avatar':_0x644a1e[_0x23c3fe(0xf8)]}));break;}case'toggle-deafen':{const _0x46994a=rooms[_0x23c3fe(0x11a)](_0x54acc5[_0x23c3fe(0x10d)]);if(!_0x46994a)return;const _0x3ab5e2=_0x46994a[_0x23c3fe(0x11e)][_0x23c3fe(0x11a)](_0x2ba435);_0x3ab5e2&&(_0x3ab5e2[_0x23c3fe(0x135)]=_0x644a1e['isDeafened'],broadcast(_0x54acc5[_0x23c3fe(0x10d)],{'type':_0x23c3fe(0x108),'clientId':_0x2ba435,'isDeafened':_0x644a1e[_0x23c3fe(0x135)]}));break;}case _0x23c3fe(0xd9):{const _0x259080=rooms[_0x23c3fe(0x11a)](_0x54acc5['roomId']);if(!_0x259080)return;const _0x2fa2ee=_0x259080['participants'][_0x23c3fe(0x11a)](_0x2ba435);_0x2fa2ee&&(_0x2fa2ee[_0x23c3fe(0x11b)]=!0x0,broadcast(_0x54acc5[_0x23c3fe(0x10d)],{'type':_0x23c3fe(0xd9),'clientId':_0x2ba435,'nickname':_0x54acc5[_0x23c3fe(0x10a)]}));break;}case _0x23c3fe(0x10c):{const _0x3dd10c=rooms[_0x23c3fe(0x11a)](_0x54acc5['roomId']);if(!_0x3dd10c)return;const _0x522095=_0x3dd10c[_0x23c3fe(0x11e)][_0x23c3fe(0x11a)](_0x2ba435);_0x522095&&(_0x522095[_0x23c3fe(0x11b)]=!0x1,broadcast(_0x54acc5[_0x23c3fe(0x10d)],{'type':'screen-share-stopped','clientId':_0x2ba435}));break;}case _0x23c3fe(0xf4):{const {targetId:_0x54ece7}=_0x644a1e;sendToClient(_0x54ece7,{'type':_0x23c3fe(0x114),'requesterId':_0x2ba435});break;}}}setInterval(()=>{const _0x56e347=_0x3365ab,_0x7f4d10=Date[_0x56e347(0xdc)]();for(const [_0x170ab6,_0x4a9ccf]of rateLimit['entries']())_0x7f4d10>_0x4a9ccf['resetTime']&&rateLimit[_0x56e347(0x12c)](_0x170ab6);},0xea60),app['set'](_0x3365ab(0x128),!0x0),app['use'](express[_0x3365ab(0x120)](path['join'](__dirname,_0x3365ab(0x138)))),app[_0x3365ab(0xfc)](express[_0x3365ab(0x140)]({'limit':_0x3365ab(0xde)})),app[_0x3365ab(0x11a)]('/',(_0x222018,_0xb7d7b7)=>{const _0x180a2a=_0x3365ab;_0xb7d7b7[_0x180a2a(0xf9)](path[_0x180a2a(0xda)](__dirname,_0x180a2a(0x138),'index.html'));}),app[_0x3365ab(0x11a)]('/room/:roomId',(_0x29492c,_0x27b629)=>{const _0x2196b3=_0x3365ab;_0x27b629['sendFile'](path['join'](__dirname,_0x2196b3(0x138),_0x2196b3(0x13c)));}),app['get'](_0x3365ab(0x123),(_0x4374a2,_0x2b9078)=>{const _0x288f30=_0x3365ab,_0x1ee150=uuidv4(),_0xadd90=getClientIP(_0x4374a2);csrfTokens['set'](_0x1ee150,{'ip':_0xadd90,'createdAt':Date[_0x288f30(0xdc)]()}),setTimeout(()=>csrfTokens[_0x288f30(0x12c)](_0x1ee150),0x493e0),_0x2b9078[_0x288f30(0x140)]({'d':_0x1ee150});}),app[_0x3365ab(0xf5)]('/x/c',(_0x4c8f76,_0x292425)=>{const _0x1c7282=_0x3365ab,_0x1e7eb2=getClientIP(_0x4c8f76),_0x1dc46c=_0x4c8f76['headers'][_0x1c7282(0x12e)];if(!_0x1dc46c||!csrfTokens[_0x1c7282(0xdb)](_0x1dc46c))return _0x292425[_0x1c7282(0xf6)](0x193)[_0x1c7282(0x140)]({'c':ERR['E001']});const _0x2715a6=csrfTokens[_0x1c7282(0x11a)](_0x1dc46c);csrfTokens[_0x1c7282(0x12c)](_0x1dc46c);const _0xad66bb=Date['now']()-_0x2715a6[_0x1c7282(0x118)];if(_0xad66bb>0x493e0)return _0x292425[_0x1c7282(0xf6)](0x193)[_0x1c7282(0x140)]({'c':ERR['E002']});if(_0xad66bb<0x3e8)return suspiciousIPs[_0x1c7282(0x12a)](_0x1e7eb2),_0x292425[_0x1c7282(0xf6)](0x193)['json']({'c':ERR['E003']});if(!isValidRequest(_0x4c8f76))return suspiciousIPs['add'](_0x1e7eb2),_0x292425['status'](0x193)[_0x1c7282(0x140)]({'c':ERR[_0x1c7282(0x143)]});if(!checkRateLimit(_0x1e7eb2))return _0x292425[_0x1c7282(0xf6)](0x1ad)[_0x1c7282(0x140)]({'c':ERR['E005']});if(rooms[_0x1c7282(0x134)]>=0x5)return _0x292425[_0x1c7282(0xf6)](0x1f7)[_0x1c7282(0x140)]({'c':ERR[_0x1c7282(0xff)],'limit':!0x0});const _0x577194=uuidv4()[_0x1c7282(0x129)](0x0,0x8),_0x37ea67=uuidv4()[_0x1c7282(0x129)](0x0,0xc);rooms[_0x1c7282(0x103)](_0x577194,{'id':_0x577194,'adminKey':_0x37ea67,'createdAt':Date[_0x1c7282(0xdc)](),'lastEmptyTime':Date[_0x1c7282(0xdc)](),'participants':new Map(),'messages':[]}),_0x292425[_0x1c7282(0x140)]({'r':_0x577194,'k':_0x37ea67,'l':_0x1c7282(0xfd)+_0x577194});}),app['get']('/x/r/:roomId',(_0x23c68d,_0x1ac5c9)=>{const _0x27478e=_0x3365ab,_0x3c5a74=rooms[_0x27478e(0x11a)](_0x23c68d[_0x27478e(0xf7)][_0x27478e(0x10d)]);if(!_0x3c5a74)return _0x1ac5c9[_0x27478e(0xf6)](0x194)[_0x27478e(0x140)]({'c':0x0});_0x1ac5c9[_0x27478e(0x140)]({'e':0x1,'p':_0x3c5a74[_0x27478e(0x11e)][_0x27478e(0x134)]});}),wss['on'](_0x3365ab(0x13e),_0x55edd2=>{const _0x4fe3bd=_0x3365ab,_0x1ee1ca=uuidv4();clients[_0x4fe3bd(0x103)](_0x1ee1ca,{'ws':_0x55edd2,'roomId':null,'nickname':null,'odId':null}),_0x55edd2[_0x4fe3bd(0xeb)](JSON[_0x4fe3bd(0x109)]({'type':_0x4fe3bd(0xf1),'clientId':_0x1ee1ca})),_0x55edd2['on'](_0x4fe3bd(0x119),_0x244666=>{const _0x54454b=_0x4fe3bd;try{const _0x3725dc=JSON[_0x54454b(0xfe)](_0x244666);handleMessage(_0x1ee1ca,_0x3725dc);}catch(_0xc0c96){console[_0x54454b(0xe2)](_0x54454b(0xe5),_0xc0c96);}}),_0x55edd2['on'](_0x4fe3bd(0x101),()=>{const _0x44438d=_0x4fe3bd,_0x881526=clients[_0x44438d(0x11a)](_0x1ee1ca);if(_0x881526&&_0x881526[_0x44438d(0x10d)]){const _0xcefd18=rooms[_0x44438d(0x11a)](_0x881526[_0x44438d(0x10d)]);_0xcefd18&&(_0xcefd18[_0x44438d(0x11e)][_0x44438d(0x12c)](_0x1ee1ca),0x0===_0xcefd18[_0x44438d(0x11e)][_0x44438d(0x134)]&&(_0xcefd18[_0x44438d(0x110)]=Date[_0x44438d(0xdc)]()),broadcast(_0x881526['roomId'],{'type':'user-left','clientId':_0x1ee1ca,'nickname':_0x881526['nickname']}),broadcast(_0x881526[_0x44438d(0x10d)],{'type':_0x44438d(0xdf),'participants':Array['from'](_0xcefd18[_0x44438d(0x11e)]['values']())}));}clients[_0x44438d(0x12c)](_0x1ee1ca);});}),setInterval(()=>{const _0x54baf9=_0x3365ab,_0x25327a=Date[_0x54baf9(0xdc)]();rooms[_0x54baf9(0xef)]((_0x50c4ef,_0x2f4dce)=>{const _0x91d0c7=_0x54baf9;0x0===_0x50c4ef[_0x91d0c7(0x11e)]['size']&&_0x50c4ef[_0x91d0c7(0x110)]&&_0x25327a-_0x50c4ef[_0x91d0c7(0x110)]>0x927c0&&(rooms[_0x91d0c7(0x12c)](_0x2f4dce),console['log']('Room\x20'+_0x2f4dce+_0x91d0c7(0x13f)));});},0xea60);function _0x458b(_0x74049d,_0x5304e9){const _0x2f2573=_0x2f25();return _0x458b=function(_0x458bf3,_0x3144d9){_0x458bf3=_0x458bf3-0xd8;let _0x962409=_0x2f2573[_0x458bf3];return _0x962409;},_0x458b(_0x74049d,_0x5304e9);}const PORT=process[_0x3365ab(0xe3)]['PORT']||0xbb8;server[_0x3365ab(0x11c)](PORT,()=>{const _0x4b7b1a=_0x3365ab;console[_0x4b7b1a(0xfa)]('Server\x20running\x20on\x20http://localhost:'+PORT);});